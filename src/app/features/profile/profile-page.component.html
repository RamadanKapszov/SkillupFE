<div class="profile-layout" *ngIf="!loading && !error; else loadingTpl">
  <div class="profile-grid">
    <!-- === LEFT COLUMN: Dashboard Overview === -->
    <div class="profile-left">
      <div class="profile-header">
        <img
          [src]="user?.avatarUrl || '/assets/img/default-avatar.png'"
          alt="Avatar"
          class="avatar"
        />
        <div>
          <h2>{{ user?.username }}</h2>
          <p>{{ user?.email }}</p>
          <p class="points">üèÜ {{ user?.totalPoints }} —Ç–æ—á–∫–∏</p>
        </div>
      </div>

      <div class="progress-card">
        <h3>üìä –ü—Ä–æ–≥—Ä–µ—Å</h3>
        <div class="progress-bar">
          <div
            class="progress-fill"
            [style.width.%]="user?.progressPercent"
          ></div>
        </div>
        <p>{{ user?.progressPercent }}% –∑–∞–≤—ä—Ä—à–µ–Ω–∏ —É—Ä–æ—Ü–∏</p>
      </div>

      <div class="dashboard-sections">
        <div class="section">
          <h3>üß© –ü–æ—Å–ª–µ–¥–Ω–∏ —Ç–µ—Å—Ç–æ–≤–µ</h3>
          <ul>
            <li *ngFor="let t of user?.completedTests">
              <strong>{{ t.title }}</strong> ‚Äî {{ t.score }} —Ç–æ—á–∫–∏
              <small>{{ t.completedAt | date : "dd.MM.yyyy HH:mm" }}</small>
            </li>
          </ul>
        </div>

        <div class="section">
          <h3>üèÖ –ë–∞–¥–∂–æ–≤–µ</h3>
          <div class="badges">
            <div class="badge" *ngFor="let b of user?.badges">
              <img [src]="b.iconUrl" alt="{{ b.name }}" />
              <span>{{ b.name }}</span>
            </div>
          </div>
        </div>

        <div class="profile-section" *ngIf="enrolledCourses?.length">
          <h3>üìò –ú–æ–∏—Ç–µ –∫—É—Ä—Å–æ–≤–µ</h3>
          <div class="courses-list">
            <div
              class="course-card"
              *ngFor="let c of enrolledCourses"
              (click)="openCourse(c.id)"
            >
              <img
                [src]="c.imageUrl || '/assets/img/default-course.jpg'"
                alt="{{ c.title }}"
              />
              <div class="course-info">
                <h4>{{ c.title }}</h4>
                <small
                  >üìÖ –ó–∞–ø–∏—Å–∞–Ω –Ω–∞:
                  {{ c.enrolledAt | date : "dd.MM.yyyy" }}</small
                >
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- === RIGHT COLUMN: Settings Panel === -->
    <div class="profile-settings">
      <h2>‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –Ω–∞ –ø—Ä–æ—Ñ–∏–ª–∞</h2>
      <form (ngSubmit)="updateProfile()" #settingsForm="ngForm">
        <label>–ü–æ—Ç—Ä–µ–±–∏—Ç–µ–ª—Å–∫–æ –∏–º–µ</label>
        <input
          type="text"
          name="username"
          [(ngModel)]="editData.username"
          placeholder="–í—ä–≤–µ–¥–∏ –Ω–æ–≤–æ –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª—Å–∫–æ –∏–º–µ"
        />

        <label>–ò–º–µ–π–ª</label>
        <input
          type="email"
          name="email"
          [(ngModel)]="editData.email"
          placeholder="example@email.com"
        />

        <button class="btn gradient" type="submit">üíæ –ó–∞–ø–∞–∑–∏ –ø—Ä–æ–º–µ–Ω–∏—Ç–µ</button>
      </form>

      <div class="divider"></div>

      <div class="password-section">
        <h3>üîê –°–º—è–Ω–∞ –Ω–∞ –ø–∞—Ä–æ–ª–∞</h3>

        <form (ngSubmit)="changePassword()" #pwdForm="ngForm" class="pwd-form">
          <label>–°—Ç–∞—Ä–∞ –ø–∞—Ä–æ–ª–∞</label>
          <input
            type="password"
            name="oldPassword"
            [(ngModel)]="pwd.old"
            required
            placeholder="–¢–µ–∫—É—â–∞ –ø–∞—Ä–æ–ª–∞"
          />

          <label>–ù–æ–≤–∞ –ø–∞—Ä–æ–ª–∞</label>
          <input
            type="password"
            name="newPassword"
            [(ngModel)]="pwd.new"
            required
            minlength="6"
            placeholder="–ù–æ–≤–∞ –ø–∞—Ä–æ–ª–∞ (–º–∏–Ω. 6 —Å–∏–º–≤–æ–ª–∞)"
          />

          <button class="btn gradient" type="submit">üîÑ –°–º–µ–Ω–∏ –ø–∞—Ä–æ–ª–∞—Ç–∞</button>
        </form>
      </div>

      <div class="avatar-update">
        <h3>üñºÔ∏è –°–º–µ–Ω–∏ —Å–Ω–∏–º–∫–∞—Ç–∞</h3>
        <input
          id="avatarUpload"
          type="file"
          (change)="uploadAvatar($event)"
          hidden
        />
        <label for="avatarUpload" class="upload-btn">–ö–∞—á–∏ –Ω–æ–≤–∞ —Å–Ω–∏–º–∫–∞</label>
      </div>
    </div>
  </div>
</div>

<ng-template #loadingTpl>
  <div class="loading">
    <app-loading-spinner></app-loading-spinner>
  </div>
</ng-template>
