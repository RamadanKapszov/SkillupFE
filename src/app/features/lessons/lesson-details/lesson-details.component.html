<div class="lesson-layout" *ngIf="lesson && !loading; else loadingTpl">
  <!-- === üß≠ SIDEBAR === -->
  <aside class="lesson-sidebar">
    <h3>üìö –£—Ä–æ—Ü–∏ –≤ –∫—É—Ä—Å–∞</h3>

    <div class="progress-mini" *ngIf="totalLessons > 0">
      <div class="progress-bar-mini">
        <div class="progress-fill-mini" [style.width.%]="progressPercent"></div>
      </div>
      <p>{{ completedLessons }}/{{ totalLessons }} —É—Ä–æ–∫–∞</p>
    </div>

    <ul class="lesson-list">
      <li
        *ngFor="let l of lessons"
        [class.active]="l.id === lesson.id"
        (click)="viewLesson(l.id)"
      >
        <span>{{ l.orderIndex }}.</span> {{ l.title }}
      </li>
    </ul>

    <div class="sidebar-actions">
      <button class="btn small" (click)="goBack()">‚¨ÖÔ∏è –ö—ä–º –∫—É—Ä—Å–∞</button>
      <button class="btn small gradient" (click)="nextLesson()">
        –°–ª–µ–¥–≤–∞—â —É—Ä–æ–∫ ‚Üí
      </button>
    </div>
  </aside>

  <!-- === üìñ MAIN CONTENT === -->
  <main class="lesson-page">
    <div class="lesson-header">
      <h2>{{ lesson.title }}</h2>
    </div>

    <!-- üë©‚Äçüè´ Teacher -->
    <section class="teacher-card" *ngIf="lesson.teacherUsername">
      <img
        [src]="
          'https://api.dicebear.com/7.x/initials/svg?seed=' +
          lesson.teacherUsername
        "
        alt="Teacher Avatar"
        class="teacher-avatar"
      />
      <div>
        <h3>{{ lesson.teacherUsername }}</h3>
        <p>–ü—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª</p>
      </div>
    </section>

    <!-- üé¨ Video -->
    <div *ngIf="lesson.contentUrl" class="lesson-video">
      <div class="video-frame">
        <iframe
          [src]="lesson.contentUrl | safeUrl"
          frameborder="0"
          allowfullscreen
        ></iframe>
      </div>
    </div>

    <!-- üìò Description -->
    <section class="lesson-content">
      <h3>üìñ –û–ø–∏—Å–∞–Ω–∏–µ</h3>
      <p>{{ lesson.description || "–ù—è–º–∞ –Ω–∞–ª–∏—á–Ω–æ –æ–ø–∏—Å–∞–Ω–∏–µ." }}</p>
    </section>

    <!-- ‚úÖ Completion -->
    <section class="lesson-actions" *ngIf="!checkingProgress">
      <button
        *ngIf="!completed"
        class="btn complete-btn"
        (click)="markCompleted()"
      >
        ‚úÖ –ú–∞—Ä–∫–∏—Ä–∞–π –∫–∞—Ç–æ –∑–∞–≤—ä—Ä—à–µ–Ω
      </button>
      <div *ngIf="completed" class="completed-tag">üéâ –£—Ä–æ–∫—ä—Ç –µ –∑–∞–≤—ä—Ä—à–µ–Ω!</div>
    </section>

    <!-- üß† Test -->
    <section class="test-section" *ngIf="test">
      <h3>üß© –¢–µ—Å—Ç –∫—ä–º —É—Ä–æ–∫–∞</h3>
      <p>
        {{ test.questions.length }} –≤—ä–ø—Ä–æ—Å–∞ ‚Äî –º–∞–∫—Å. {{ test.maxPoints }} —Ç–æ—á–∫–∏
      </p>
      <button class="btn gradient" (click)="startTest()">
        üöÄ –ó–∞–ø–æ—á–Ω–∏ —Ç–µ—Å—Ç–∞
      </button>
    </section>

    <!-- üí¨ Reviews -->
    <section class="reviews-section">
      <h3>üí¨ –†–µ–≤—é—Ç–∞</h3>
      <div *ngIf="reviews.length > 0; else noReviews">
        <div class="review-item" *ngFor="let r of reviews">
          <div class="review-header">
            <strong>{{ r.studentUsername || "–ê–Ω–æ–Ω–∏–º–µ–Ω" }}</strong>
            <span class="stars">‚≠ê {{ r.rating }}/5</span>
          </div>
          <p class="review-comment">{{ r.comment }}</p>
          <small class="review-date">{{ r.createdAt | date : "medium" }}</small>

          <div class="review-actions" *ngIf="isMyReview(r)">
            <button class="btn-outline edit" (click)="editReview(r)">
              ‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–∞–π
            </button>
            <button class="btn-outline delete" (click)="deleteReview(r.id)">
              üóëÔ∏è –ò–∑—Ç—Ä–∏–π
            </button>
          </div>
        </div>
      </div>
      <ng-template #noReviews>
        <p class="no-reviews">üòî –í—Å–µ –æ—â–µ –Ω—è–º–∞ —Ä–µ–≤—é—Ç–∞. –ë—ä–¥–∏ –ø—ä—Ä–≤–∏—è—Ç!</p>
      </ng-template>
    </section>

    <!-- ‚úçÔ∏è Add/Edit Review -->
    <section class="add-review" [class.editing]="editingReviewId">
      <h3 *ngIf="!editingReviewId">üìù –î–æ–±–∞–≤–∏ —Ä–µ–≤—é</h3>
      <h3 *ngIf="editingReviewId">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–∞–π —Ä–µ–≤—é</h3>

      <label>‚≠ê –û—Ü–µ–Ω–∫–∞:</label>
      <select [(ngModel)]="newReview.rating">
        <option [ngValue]="0">–ò–∑–±–µ—Ä–µ—Ç–µ...</option>
        <option *ngFor="let r of [1, 2, 3, 4, 5]" [ngValue]="r">{{ r }}</option>
      </select>

      <textarea
        [(ngModel)]="newReview.comment"
        placeholder="–í–∞—à–∏—è—Ç –∫–æ–º–µ–Ω—Ç–∞—Ä..."
      ></textarea>

      <div class="review-buttons">
        <button
          class="btn gradient"
          (click)="submitReview()"
          [disabled]="submitting"
        >
          {{ editingReviewId ? "üíæ –ó–∞–ø–∞–∑–∏" : "üì© –ò–∑–ø—Ä–∞—Ç–∏" }}
        </button>
        <button
          *ngIf="editingReviewId"
          class="btn cancel"
          (click)="cancelEdit()"
        >
          ‚ùå –û—Ç–∫–∞–∑
        </button>
      </div>
    </section>
  </main>
</div>

<ng-template #loadingTpl>
  <div class="loading">
    <app-loading-spinner></app-loading-spinner>
  </div>
</ng-template>
